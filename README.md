# LINE Bot ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Google Calendar ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏≤

‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Google Apps Script ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° LINE Messaging API ‡∏Å‡∏±‡∏ö Google Calendar ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (medication reminder)  
‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏•‡∏ö/‡∏î‡∏π Event ‡πÉ‡∏ô Google Calendar ‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ú‡πà‡∏≤‡∏ô LINE

---

## ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å

- ‡∏™‡∏£‡πâ‡∏≤‡∏á Event (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤) ‡πÉ‡∏ô Google Calendar
- ‡∏•‡∏ö Event ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
- ‡∏î‡∏π Event ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ, ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ, ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
- ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤
- ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô LINE Push Message
- ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ Event ‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô

---

## ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Apps Script Project

- ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà https://script.google.com/
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà
- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ)
- ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå `Code.gs` ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà

### 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ä‡πà‡∏ô

```js
const LINE_TOKEN = '‡πÉ‡∏™‡πà LINE Channel Access Token ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
const LINE_USER_ID = '‡πÉ‡∏™‡πà LINE User ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Push';
const CALENDAR_ID = '‡πÉ‡∏™‡πà Google Calendar ID ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ "primary"';

// === MEDICATION STORAGE ===
// ‡πÉ‡∏ä‡πâ PropertiesService ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÅ‡∏ó‡∏ô localStorage
function getMedications() {
  const stored = PropertiesService.getScriptProperties().getProperty('medications');
  return stored ? JSON.parse(stored) : [];
}

function saveMedications(medications) {
  PropertiesService.getScriptProperties().setProperty('medications', JSON.stringify(medications));
}

// === MAIN ===
function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const message = data.events[0].message.text.trim();

  const calendar = CalendarApp.getCalendarById(CALENDAR_ID);

  // üÜò ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  if (/^help$|^‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠$/i.test(message)) {
    const helpMsg = `
üÜò ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Google Calendar ‡∏ú‡πà‡∏≤‡∏ô LINE:

üìÖ CALENDAR:
1Ô∏è‚É£ ‡∏™‡∏£‡πâ‡∏≤‡∏á Event:
‡∏™‡∏£‡πâ‡∏≤‡∏á : ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
(‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)

‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤:
‡∏™‡∏£‡πâ‡∏≤‡∏á : ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
‡πÄ‡∏ß‡∏•‡∏≤ : 2025-06-01

‡∏´‡∏£‡∏∑‡∏≠:
‡∏™‡∏£‡πâ‡∏≤‡∏á : ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° : 2025-06-01 14:00
‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö : 2025-06-01 15:30

2Ô∏è‚É£ ‡∏•‡∏ö Event:
‡∏•‡∏ö : ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°

3Ô∏è‚É£ ‡∏î‡∏π Event:
‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ

üíä MEDICATION:
4Ô∏è‚É£ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤:
‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤ : ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î
‡πÄ‡∏ß‡∏•‡∏≤ : 08:00,14:00,20:00
(‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)

5Ô∏è‚É£ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤:
‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤

6Ô∏è‚É£ ‡∏•‡∏ö‡∏¢‡∏≤:
‡∏•‡∏ö‡∏¢‡∏≤ : ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î

7Ô∏è‚É£ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:
‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ

üìå ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: yyyy-mm-dd
üìå ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: HH:mm (24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
    `;
    replyToLine(data, helpMsg.trim());
    return;
  }

  // üíä ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏¢‡∏≤
  if (/^‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤/i.test(message)) {
    handleAddMedication(data, message);
    return;
  }
  
  if (/^‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤$/i.test(message)) {
    handleListMedications(data);
    return;
  }
  
  if (/^‡∏•‡∏ö‡∏¢‡∏≤/i.test(message)) {
    handleDeleteMedication(data, message);
    return;
  }
  
  if (/^‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ$/i.test(message)) {
    handleTodayMedications(data);
    return;
  }

  // üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  if (/^‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/i.test(message)) {
    sendEventSummary(data, 0);
    return;
  }
  if (/^‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ/i.test(message)) {
    sendEventSummary(data, 1);
    return;
  }
  if (/‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ô‡∏µ‡πâ|‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ/i.test(message)) {
    sendWeeklySummary(data);
    return;
  }

  // üóë ‡∏•‡∏ö Event
  if (message.startsWith("‡∏•‡∏ö :")) {
    const name = message.match(/‡∏•‡∏ö ?: ?(.*)/)?.[1]?.trim();
    if (!name) return;
    const events = calendar.getEvents(new Date(), new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
    const match = events.find(ev => ev.getTitle() === name);
    if (match) {
      match.deleteEvent();
      replyToLine(data, `üóëÔ∏è ‡∏•‡∏ö "${name}" ‡πÅ‡∏•‡πâ‡∏ß`);
    } else {
      replyToLine(data, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö "${name}" ‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô`);
    }
    return;
  }

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Event
  if (message.startsWith("‡∏™‡∏£‡πâ‡∏≤‡∏á :")) {
    const name = message.match(/‡∏™‡∏£‡πâ‡∏≤‡∏á ?: ?(.*)/)?.[1]?.trim();
    const startStr = message.match(/‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ?: ?(.+)/)?.[1]?.trim();
    const endStr = message.match(/‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö ?: ?(.+)/)?.[1]?.trim();
    const dateOnly = message.match(/‡πÄ‡∏ß‡∏•‡∏≤ ?: ?([0-9]{4}-[0-9]{2}-[0-9]{2})/)?.[1];

    if (!name) {
      replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ Event ‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á : ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°");
      return;
    }

    if (startStr && endStr) {
      const start = new Date(startStr);
      const end = new Date(endStr);
      if (isNaN(start) || isNaN(end)) {
        replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô yyyy-mm-dd HH:mm)");
        return;
      }
      calendar.createEvent(name, start, end);
      replyToLine(data, `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á "${name}" ‡πÄ‡∏ß‡∏•‡∏≤ ${formatTime(start)} - ${formatTime(end)}`);
      return;
    }

    if (dateOnly) {
      const date = new Date(dateOnly);
      if (isNaN(date)) {
        replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô yyyy-mm-dd)");
        return;
      }
      calendar.createAllDayEvent(name, date);
      replyToLine(data, `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á "${name}" ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(date)}`);
      return;
    }

    calendar.createAllDayEvent(name, new Date());
    replyToLine(data, `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á "${name}" ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`);
  }
}

// === üíä MEDICATION FUNCTIONS ===
function handleAddMedication(data, message) {
  const nameMatch = message.match(/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤ ?: ?(.*?)(?=\n|‡πÄ‡∏ß‡∏•‡∏≤|$)/)?.[1]?.trim();
  const timeMatch = message.match(/‡πÄ‡∏ß‡∏•‡∏≤ ?: ?(.+)/)?.[1]?.trim();
  
  if (!nameMatch) {
    replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤ : ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î");
    return;
  }
  
  if (!timeMatch) {
    replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏ß‡∏•‡∏≤ : 08:00,14:00,20:00");
    return;
  }
  
  const times = timeMatch.split(',').map(t => t.trim()).filter(t => /^\d{2}:\d{2}$/.test(t));
  
  if (times.length === 0) {
    replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ HH:MM ‡πÄ‡∏ä‡πà‡∏ô 08:00");
    return;
  }
  
  const medications = getMedications();
  const existing = medications.find(med => med.name === nameMatch);
  
  if (existing) {
    existing.times = times;
  } else {
    medications.push({
      name: nameMatch,
      times: times,
      createdAt: new Date().toISOString()
    });
  }
  
  saveMedications(medications);
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á triggers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  createMedicationTriggers(nameMatch, times);
  
  replyToLine(data, `üíä ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤ "${nameMatch}" ‡πÅ‡∏•‡πâ‡∏ß\nüïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏¥‡∏ô: ${times.join(', ')}\n‚è∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô`);
}

function handleListMedications(data) {
  const medications = getMedications();
  
  if (medications.length === 0) {
    replyToLine(data, "üíä ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }
  
  let msg = "üíä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n";
  medications.forEach((med, index) => {
    msg += `\n${index + 1}. ${med.name}\nüïí ‡πÄ‡∏ß‡∏•‡∏≤: ${med.times.join(', ')}`;
  });
  
  replyToLine(data, msg);
}

function handleDeleteMedication(data, message) {
  const name = message.match(/‡∏•‡∏ö‡∏¢‡∏≤ ?: ?(.*)/)?.[1]?.trim();
  
  if (!name) {
    replyToLine(data, "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
    return;
  }
  
  const medications = getMedications();
  const index = medications.findIndex(med => med.name === name);
  
  if (index === -1) {
    replyToLine(data, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤ "${name}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
    return;
  }
  
  medications.splice(index, 1);
  saveMedications(medications);
  
  // ‡∏•‡∏ö triggers ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
  deleteMedicationTriggers(name);
  
  replyToLine(data, `üóëÔ∏è ‡∏•‡∏ö‡∏¢‡∏≤ "${name}" ‡πÅ‡∏•‡πâ‡∏ß`);
}

function handleTodayMedications(data) {
  const medications = getMedications();
  
  if (medications.length === 0) {
    replyToLine(data, "üíä ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }
  
  const now = new Date();
  const currentTime = Utilities.formatDate(now, "Asia/Bangkok", "HH:mm");
  
  let msg = "üíä ‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:\n";
  
  medications.forEach(med => {
    msg += `\nüìå ${med.name}`;
    med.times.forEach(time => {
      const status = time <= currentTime ? "‚úÖ" : "‚è∞";
      msg += `\n${status} ${time}`;
    });
  });
  
  replyToLine(data, msg);
}

// === üîî MEDICATION TRIGGERS ===
function createMedicationTriggers(medName, times) {
  // ‡∏•‡∏ö trigger ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  deleteMedicationTriggers(medName);
  
  times.forEach(time => {
    const [hour, minute] = time.split(':').map(Number);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á trigger ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
    ScriptApp.newTrigger('sendMedicationReminder')
      .timeBased()
      .everyDays(1)
      .atHour(hour)
      .nearMinute(minute)
      .create();
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• trigger
    const triggers = getTriggerData();
    triggers.push({
      medName: medName,
      time: time,
      type: 'medication'
    });
    saveTriggerData(triggers);
  });
}

function deleteMedicationTriggers(medName) {
  const triggers = ScriptApp.getProjectTriggers();
  const triggerData = getTriggerData();
  
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'sendMedicationReminder') {
      const relatedData = triggerData.find(t => t.medName === medName && t.type === 'medication');
      if (relatedData) {
        ScriptApp.deleteTrigger(trigger);
      }
    }
  });
  
  // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• trigger
  const updatedTriggers = triggerData.filter(t => !(t.medName === medName && t.type === 'medication'));
  saveTriggerData(updatedTriggers);
}

function getTriggerData() {
  const stored = PropertiesService.getScriptProperties().getProperty('triggerData');
  return stored ? JSON.parse(stored) : [];
}

function saveTriggerData(data) {
  PropertiesService.getScriptProperties().setProperty('triggerData', JSON.stringify(data));
}

// === üîî MEDICATION REMINDER ===
function sendMedicationReminder() {
  const now = new Date();
  const currentTime = Utilities.formatDate(now, "Asia/Bangkok", "HH:mm");
  const medications = getMedications();
  
  medications.forEach(med => {
    if (med.times.includes(currentTime)) {
      const msg = `üíä ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß!\n\nüîî ${med.name}\nüïí ‡πÄ‡∏ß‡∏•‡∏≤: ${currentTime}\n\nüí° ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö`;
      sendLinePush(msg);
    }
  });
}

// === üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Event ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ===
function sendEventSummary(data, offsetDay = 0) {
  const date = new Date();
  date.setDate(date.getDate() + offsetDay);
  const events = CalendarApp.getCalendarById(CALENDAR_ID).getEventsForDay(date);

  if (!events.length) {
    replyToLine(data, offsetDay === 0 ? "üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ Event" : "üìÖ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ Event");
    return;
  }

  let msg = `üìÖ Event ${offsetDay === 0 ? "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" : "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ"}:\n`;
  events.forEach(e => {
    msg += `\nüìå ${e.getTitle()}\nüïí ${formatTime(e.getStartTime())} - ${formatTime(e.getEndTime())}`;
  });

  replyToLine(data, msg);
}

function sendWeeklySummary(data) {
  const today = new Date();
  const next7 = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  const events = CalendarApp.getCalendarById(CALENDAR_ID).getEvents(today, next7);

  if (!events.length) {
    replyToLine(data, "üìÖ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Event");
    return;
  }

  let msg = "üìÖ Event ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:\n";
  events.forEach(e => {
    msg += `\nüìå ${e.getTitle()}\nüìÜ ${formatDate(e.getStartTime())} üïí ${formatTime(e.getStartTime())} - ${formatTime(e.getEndTime())}`;
  });

  replyToLine(data, msg);
}

// === üîÅ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö LINE ===
function replyToLine(data, msg) {
  const payload = {
    replyToken: data.events[0].replyToken,
    messages: [{ type: 'text', text: msg }]
  };
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    method: 'post',
    contentType: 'application/json',
    headers: {
      Authorization: 'Bearer ' + LINE_TOKEN
    },
    payload: JSON.stringify(payload)
  });
}

// === üïì ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ ===
function formatTime(date) {
  return Utilities.formatDate(date, "Asia/Bangkok", "HH:mm");
}

function formatDate(date) {
  return Utilities.formatDate(date, "Asia/Bangkok", "yyyy-MM-dd");
}

function sendDailyEvents() {
  const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
  const today = new Date();
  const events = calendar.getEventsForDay(today);

  if (events.length === 0) {
    sendLinePush("üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ Event ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
    return;
  }

  let msg = "üìÖ Event ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:\n";
  events.forEach(event => {
    msg += `\nüïí ${event.getTitle()}\n‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(event.getStartTime())} - ${formatTime(event.getEndTime())}`;
  });

  sendLinePush(msg);
}

function sendLinePush(msg) {
  const payload = {
    to: LINE_USER_ID,
    messages: [{ type: 'text', text: msg }]
  };

  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    method: 'post',
    contentType: 'application/json',
    headers: {
      Authorization: 'Bearer ' + LINE_TOKEN
    },
    payload: JSON.stringify(payload)
  });
}

// === üîÑ DAILY MEDICATION SUMMARY ===
function sendDailyMedicationSummary() {
  const medications = getMedications();
  
  if (medications.length === 0) return;
  
  let msg = "üíä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:\n";
  
  medications.forEach(med => {
    msg += `\nüìå ${med.name}`;
    med.times.forEach(time => {
      msg += `\n‚è∞ ${time}`;
    });
  });
  
  msg += "\n\nüí° ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!";
  
  sendLinePush(msg);
}
